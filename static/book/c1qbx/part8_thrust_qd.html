
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>8. [DRAFT] Quasidynamic thrust fault earthquake cycles (plane strain) &#8212; Integral equation tutorials</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/patch.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://tbenthompson.com/book/c1qbx/part8_thrust_qd.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="1. [DRAFT] Solving a Dirichlet problem on a circle." href="../volumetric/part1_solve_circle.html" />
    <link rel="prev" title="7. Quasidynamic earthquake cycles on two faults" href="part7_qd_two_faults.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-114592151-1', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Integral equation tutorials</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Integral equation tutorials
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  The problem space
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../fault_problems.html">
   1. Problems in earthquake science
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  The TDE sequence: triangular dislocation elements
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../tdes/sa_tdes.html">
   1. Using TDEs to build a fault model with topography.
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tdes/sa_geometry.html">
   2. A fault and topography mesh of the South America subduction zone.
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tdes/free_matvec.html">
   3. Minimizing memory usage: a matrix-free iterative solver
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tdes/low_rank.html">
   4. Low rank approximation of BEM matrices with adaptive cross approximation (ACA).
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tdes/hmatrix.html">
   5. GPU-accelerated hierarchical matrices for triangular dislocation elements.
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  The QBX sequence: quadrature by expansion
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="part1_nearfield.html">
   1. Computing boundary integrals with quadrature by expansion (QBX).
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="part2_screw_dislocation.html">
   2. QBX examples for the Laplace equation: fun with screw dislocations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="part3_surface_intersection.html">
   3. Slip on an infinite strike slip fault in an elastic half space
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="part4_topography.html">
   4. Topography
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="part5_viscoelastic.html">
   5. Viscoelasticity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="part6_qd.html">
   6. Quasidynamic earthquake cycles: antiplane
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="part7_qd_two_faults.html">
   7. Quasidynamic earthquake cycles on two faults
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   8. [DRAFT] Quasidynamic thrust fault earthquake cycles (plane strain)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  The volumetric sequence: beyond boundaries
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../volumetric/part1_solve_circle.html">
   1. [DRAFT] Solving a Dirichlet problem on a circle.
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../volumetric/part2_mms_circle.html">
   2. [DRAFT] Method of manufactured solutions (MMS) for the Poisson equation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Back matter
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../references.html">
   References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../thanks.html">
   Thanks!
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/c1qbx/part8_thrust_qd.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   8.1. Summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rate-and-state-friction">
   8.2. Rate and state friction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#quasidynamic-earthquake-cycle-derivatives">
   8.3. Quasidynamic earthquake cycle derivatives
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#integrating-through-time">
   8.4. Integrating through time
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#plotting-the-results">
   8.5. Plotting the results
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparison-against-scec-seas-results">
   8.6. Comparison against SCEC SEAS results
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><a class="reference external" href="https://strike.scec.org/cvws/seas/download/SEAS_BP3.pdf">SCEC BP3-QD</a> document is here.</p>
<div class="tex2jax_ignore mathjax_ignore section" id="draft-quasidynamic-thrust-fault-earthquake-cycles-plane-strain">
<h1><span class="section-number">8. </span>[DRAFT] Quasidynamic thrust fault earthquake cycles (plane strain)<a class="headerlink" href="#draft-quasidynamic-thrust-fault-earthquake-cycles-plane-strain" title="Permalink to this headline">¶</a></h1>
<div class="section" id="summary">
<h2><span class="section-number">8.1. </span>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Most of the code here follows almost exactly from <span class="xref myst">the previous section on strike-slip/antiplane earthquake cycles</span>.</p></li>
<li><p>Since the fault motion is in the same plane as the fault normal vectors, we are no longer operating in an antiplane approximation. Instead, we use plane strain elasticity, a different 2D reduction of full 3D elasticity.</p></li>
<li><p>One key difference is the vector nature of the displacement and the tensor nature of the stress. We must always make sure we are dealing with tractions on the correct surface.</p></li>
<li><p>We construct a mesh, build our discrete boundary integral operators, step through time and then compare against other benchmark participants’ results.</p></li>
</ul>
<p>Does this section need detailed explanation or is it best left as lonely code? Most of the explanation would be redundant with the antiplane QD document.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sympy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tectosaur2</span> <span class="kn">import</span> <span class="n">gauss_rule</span><span class="p">,</span> <span class="n">refine_surfaces</span><span class="p">,</span> <span class="n">integrate_term</span><span class="p">,</span> <span class="n">panelize_symbolic_surface</span>
<span class="kn">from</span> <span class="nn">tectosaur2.elastic2d</span> <span class="kn">import</span> <span class="n">elastic_t</span><span class="p">,</span> <span class="n">elastic_h</span>
<span class="kn">from</span> <span class="nn">tectosaur2.rate_state</span> <span class="kn">import</span> <span class="n">MaterialProps</span><span class="p">,</span> <span class="n">qd_equation</span><span class="p">,</span> <span class="n">solve_friction</span><span class="p">,</span> <span class="n">aging_law</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">surf_half_L</span> <span class="o">=</span> <span class="mi">1000000</span>
<span class="n">fault_length</span> <span class="o">=</span> <span class="mi">40000</span>
<span class="n">max_panel_length</span> <span class="o">=</span> <span class="mi">400</span>
<span class="n">n_fault</span> <span class="o">=</span> <span class="mi">400</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">shear_modulus</span> <span class="o">=</span> <span class="mf">3.2e10</span>
<span class="n">nu</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="n">quad_rule</span> <span class="o">=</span> <span class="n">gauss_rule</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">sp_t</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>

<span class="n">angle_rad</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">6</span>
<span class="n">sp_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">fault_length</span>
<span class="n">sp_y</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">sp_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">fault_length</span>
<span class="n">fault</span> <span class="o">=</span> <span class="n">panelize_symbolic_surface</span><span class="p">(</span>
    <span class="n">sp_t</span><span class="p">,</span> <span class="n">sp_x</span><span class="p">,</span> <span class="n">sp_y</span><span class="p">,</span>
    <span class="n">quad_rule</span><span class="p">,</span>
    <span class="n">n_panels</span><span class="o">=</span><span class="n">n_fault</span>
<span class="p">)</span>

<span class="n">free</span> <span class="o">=</span> <span class="n">refine_surfaces</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="n">sp_t</span><span class="p">,</span> <span class="o">-</span><span class="n">sp_t</span> <span class="o">*</span> <span class="n">surf_half_L</span><span class="p">,</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">sp_t</span><span class="p">)</span>  <span class="c1"># free surface</span>
    <span class="p">],</span>
    <span class="n">quad_rule</span><span class="p">,</span>
    <span class="n">control_points</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># nearfield surface panels and fault panels will be limited to 200m</span>
        <span class="c1"># at 200m per panel, we have ~40m per solution node because the panels</span>
        <span class="c1"># have 5 nodes each</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">fault_length</span><span class="p">,</span> <span class="n">max_panel_length</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">fault_length</span><span class="p">,</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">fault_length</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_fault</span><span class="p">)),</span>
        <span class="c1"># farfield panels will be limited to 200000 m per panel at most</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">surf_half_L</span><span class="p">,</span> <span class="mi">50000</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;The free surface mesh has </span><span class="si">{</span><span class="n">free</span><span class="o">.</span><span class="n">n_panels</span><span class="si">}</span><span class="s2"> panels with a total of </span><span class="si">{</span><span class="n">free</span><span class="o">.</span><span class="n">n_pts</span><span class="si">}</span><span class="s2"> points.&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;The fault mesh has </span><span class="si">{</span><span class="n">fault</span><span class="o">.</span><span class="n">n_panels</span><span class="si">}</span><span class="s2"> panels with a total of </span><span class="si">{</span><span class="n">fault</span><span class="o">.</span><span class="n">n_pts</span><span class="si">}</span><span class="s2"> points.&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The free surface mesh has 646 panels with a total of 3876 points.
The fault mesh has 400 panels with a total of 2400 points.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">free</span><span class="o">.</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">free</span><span class="o">.</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;k-o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fault</span><span class="o">.</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">fault</span><span class="o">.</span><span class="n">pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;r-o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x ~ \mathrm{(km)}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y ~ \mathrm{(km)}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;scaled&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/part8_thrust_qd_5_0.png" src="../_images/part8_thrust_qd_5_0.png" />
</div>
</div>
<p>And, to start off the integration, we’ll construct the operators necessary for solving for free surface displacement from fault slip.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">singularities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="o">-</span><span class="n">surf_half_L</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="n">surf_half_L</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">sp_x</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sp_t</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">sp_y</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sp_t</span><span class="p">,</span><span class="mi">1</span><span class="p">))],</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">free_disp_to_free_disp</span><span class="p">,</span> <span class="n">fault_slip_to_free_disp</span><span class="p">),</span> <span class="n">report</span> <span class="o">=</span> <span class="n">integrate_term</span><span class="p">(</span>
    <span class="n">elastic_t</span><span class="p">(</span><span class="n">nu</span><span class="p">),</span> <span class="n">free</span><span class="o">.</span><span class="n">pts</span><span class="p">,</span> <span class="n">free</span><span class="p">,</span> <span class="n">fault</span><span class="p">,</span> <span class="n">singularities</span><span class="o">=</span><span class="n">singularities</span><span class="p">,</span> <span class="n">safety_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_report</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Integration failed for observation point (54923.4, 0) , source panel center at: (54780.4, 0), panel_idx: 65, n_integrals: 100
Expansion center: (54923.4, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.21619e-10 with tolerance: 1e-13
Integration failed for observation point (54679.3, 0) , source panel center at: (54536.3, 0), panel_idx: 66, n_integrals: 100
Expansion center: (54679.3, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.01749e-10 with tolerance: 1e-13
Integration failed for observation point (-55428.2, 0) , source panel center at: (-55571.1, 0), panel_idx: 583, n_integrals: 100
Expansion center: (-55428.2, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.1784e-10 with tolerance: 1e-13
Integration failed for observation point (-55672.3, 0) , source panel center at: (-55815.3, 0), panel_idx: 584, n_integrals: 100
Expansion center: (-55672.3, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.24731e-10 with tolerance: 1e-13
Integration failed for observation point (-56160.6, 0) , source panel center at: (-56303.5, 0), panel_idx: 586, n_integrals: 100
Expansion center: (-56160.6, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.04414e-10 with tolerance: 1e-13
Integration failed for observation point (53946.8, 0) , source panel center at: (53803.9, 0), panel_idx: 69, n_integrals: 100
Expansion center: (53946.8, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.22614e-10 with tolerance: 1e-13
Integration failed for observation point (-56404.7, 0) , source panel center at: (-56547.7, 0), panel_idx: 587, n_integrals: 100
Expansion center: (-56404.7, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.18434e-10 with tolerance: 1e-13
Integration failed for observation point (-56648.9, 0) , source panel center at: (-56791.8, 0), panel_idx: 588, n_integrals: 100
Expansion center: (-56648.9, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.18325e-10 with tolerance: 1e-13
Integration failed for observation point (53458.6, 0) , source panel center at: (53315.6, 0), panel_idx: 71, n_integrals: 100
Expansion center: (53458.6, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.03613e-10 with tolerance: 1e-13
Integration failed for observation point (-56893, 0) , source panel center at: (-57036, 0), panel_idx: 589, n_integrals: 100
Expansion center: (-56893, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.2265e-10 with tolerance: 1e-13
Integration failed for observation point (53214.4, 0) , source panel center at: (53071.5, 0), panel_idx: 72, n_integrals: 100
Expansion center: (53214.4, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.21374e-10 with tolerance: 1e-13
Integration failed for observation point (-57137.1, 0) , source panel center at: (-57280.1, 0), panel_idx: 590, n_integrals: 100
Expansion center: (-57137.1, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.16954e-10 with tolerance: 1e-13
Integration failed for observation point (-57381.3, 0) , source panel center at: (-57524.2, 0), panel_idx: 591, n_integrals: 100
Expansion center: (-57381.3, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.01012e-10 with tolerance: 1e-13
Integration failed for observation point (52482, 0) , source panel center at: (52339, 0), panel_idx: 75, n_integrals: 100
Expansion center: (52482, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.0418e-10 with tolerance: 1e-13
Integration failed for observation point (-58113.7, 0) , source panel center at: (-58256.7, 0), panel_idx: 594, n_integrals: 100
Expansion center: (-58113.7, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.52153e-10 with tolerance: 1e-13
Integration failed for observation point (-58357.9, 0) , source panel center at: (-58500.8, 0), panel_idx: 595, n_integrals: 100
Expansion center: (-58357.9, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.0861e-10 with tolerance: 1e-13
Integration failed for observation point (-58602, 0) , source panel center at: (-58744.9, 0), panel_idx: 596, n_integrals: 100
Expansion center: (-58602, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.11755e-10 with tolerance: 1e-13
Integration failed for observation point (51261.3, 0) , source panel center at: (51118.3, 0), panel_idx: 80, n_integrals: 100
Expansion center: (51261.3, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.00895e-10 with tolerance: 1e-13
Integration failed for observation point (-58846.1, 0) , source panel center at: (-58989.1, 0), panel_idx: 597, n_integrals: 100
Expansion center: (-58846.1, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.10745e-10 with tolerance: 1e-13
Integration failed for observation point (-59090.3, 0) , source panel center at: (-59233.2, 0), panel_idx: 598, n_integrals: 100
Expansion center: (-59090.3, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.28339e-10 with tolerance: 1e-13
Integration failed for observation point (-59334.4, 0) , source panel center at: (-59477.4, 0), panel_idx: 599, n_integrals: 100
Expansion center: (-59334.4, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.11731e-10 with tolerance: 1e-13
Integration failed for observation point (50528.9, 0) , source panel center at: (50385.9, 0), panel_idx: 83, n_integrals: 100
Expansion center: (50528.9, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.11601e-10 with tolerance: 1e-13
Integration failed for observation point (50284.7, 0) , source panel center at: (50141.8, 0), panel_idx: 84, n_integrals: 100
Expansion center: (50284.7, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.03656e-10 with tolerance: 1e-13
Integration failed for observation point (-60066.8, 0) , source panel center at: (-60209.8, 0), panel_idx: 602, n_integrals: 100
Expansion center: (-60066.8, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.32885e-10 with tolerance: 1e-13
Integration failed for observation point (-60311, 0) , source panel center at: (-60453.9, 0), panel_idx: 603, n_integrals: 100
Expansion center: (-60311, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.07722e-10 with tolerance: 1e-13
Integration failed for observation point (-48103.9, 0) , source panel center at: (-48246.9, 0), panel_idx: 553, n_integrals: 100
Expansion center: (-48103.9, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.09896e-10 with tolerance: 1e-13
Integration failed for observation point (-48348.1, 0) , source panel center at: (-48491, 0), panel_idx: 554, n_integrals: 100
Expansion center: (-48348.1, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.03355e-10 with tolerance: 1e-13
Integration failed for observation point (-48592.2, 0) , source panel center at: (-48735.2, 0), panel_idx: 555, n_integrals: 100
Expansion center: (-48592.2, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.00231e-10 with tolerance: 1e-13
Integration failed for observation point (-49568.8, 0) , source panel center at: (-49711.7, 0), panel_idx: 559, n_integrals: 100
Expansion center: (-49568.8, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.09152e-10 with tolerance: 1e-13
Integration failed for observation point (44425.4, 0) , source panel center at: (44282.4, 0), panel_idx: 108, n_integrals: 100
Expansion center: (44425.4, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.09065e-10 with tolerance: 1e-13
Integration failed for observation point (44181.2, 0) , source panel center at: (44038.3, 0), panel_idx: 109, n_integrals: 100
Expansion center: (44181.2, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.02191e-10 with tolerance: 1e-13
Integration failed for observation point (-50057.1, 0) , source panel center at: (-50200, 0), panel_idx: 561, n_integrals: 100
Expansion center: (-50057.1, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.07811e-10 with tolerance: 1e-13
Integration failed for observation point (-50301.2, 0) , source panel center at: (-50444.2, 0), panel_idx: 562, n_integrals: 100
Expansion center: (-50301.2, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.06175e-10 with tolerance: 1e-13
Integration failed for observation point (60294.5, 0) , source panel center at: (60151.5, 0), panel_idx: 43, n_integrals: 100
Expansion center: (60294.5, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.18367e-10 with tolerance: 1e-13
Integration failed for observation point (60050.4, 0) , source panel center at: (59907.4, 0), panel_idx: 44, n_integrals: 100
Expansion center: (60050.4, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.32672e-10 with tolerance: 1e-13
Integration failed for observation point (59806.2, 0) , source panel center at: (59663.3, 0), panel_idx: 45, n_integrals: 100
Expansion center: (59806.2, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.05741e-10 with tolerance: 1e-13
Integration failed for observation point (59562.1, 0) , source panel center at: (59419.1, 0), panel_idx: 46, n_integrals: 100
Expansion center: (59562.1, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.27496e-10 with tolerance: 1e-13
Integration failed for observation point (59073.8, 0) , source panel center at: (58930.8, 0), panel_idx: 48, n_integrals: 100
Expansion center: (59073.8, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.19685e-10 with tolerance: 1e-13
Integration failed for observation point (-52742.6, 0) , source panel center at: (-52885.6, 0), panel_idx: 572, n_integrals: 100
Expansion center: (-52742.6, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.00087e-10 with tolerance: 1e-13
Integration failed for observation point (58829.6, 0) , source panel center at: (58686.7, 0), panel_idx: 49, n_integrals: 100
Expansion center: (58829.6, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.13284e-10 with tolerance: 1e-13
Integration failed for observation point (58585.5, 0) , source panel center at: (58442.6, 0), panel_idx: 50, n_integrals: 100
Expansion center: (58585.5, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.35911e-10 with tolerance: 1e-13
Integration failed for observation point (58341.4, 0) , source panel center at: (58198.4, 0), panel_idx: 51, n_integrals: 100
Expansion center: (58341.4, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.29603e-10 with tolerance: 1e-13
Integration failed for observation point (58097.2, 0) , source panel center at: (57954.3, 0), panel_idx: 52, n_integrals: 100
Expansion center: (58097.2, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.1575e-10 with tolerance: 1e-13
Integration failed for observation point (57853.1, 0) , source panel center at: (57710.1, 0), panel_idx: 53, n_integrals: 100
Expansion center: (57853.1, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.23982e-10 with tolerance: 1e-13
Integration failed for observation point (-53963.3, 0) , source panel center at: (-54106.3, 0), panel_idx: 577, n_integrals: 100
Expansion center: (-53963.3, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.15193e-10 with tolerance: 1e-13
Integration failed for observation point (57608.9, 0) , source panel center at: (57466, 0), panel_idx: 54, n_integrals: 100
Expansion center: (57608.9, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.11028e-10 with tolerance: 1e-13
Integration failed for observation point (-54207.5, 0) , source panel center at: (-54350.4, 0), panel_idx: 578, n_integrals: 100
Expansion center: (-54207.5, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.14939e-10 with tolerance: 1e-13
Integration failed for observation point (57364.8, 0) , source panel center at: (57221.8, 0), panel_idx: 55, n_integrals: 100
Expansion center: (57364.8, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.16325e-10 with tolerance: 1e-13
Integration failed for observation point (-54451.6, 0) , source panel center at: (-54594.6, 0), panel_idx: 579, n_integrals: 100
Expansion center: (-54451.6, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.0258e-10 with tolerance: 1e-13
Integration failed for observation point (57120.7, 0) , source panel center at: (56977.7, 0), panel_idx: 56, n_integrals: 100
Expansion center: (57120.7, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.05885e-10 with tolerance: 1e-13
Integration failed for observation point (-54695.7, 0) , source panel center at: (-54838.7, 0), panel_idx: 580, n_integrals: 100
Expansion center: (-54695.7, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.01741e-10 with tolerance: 1e-13
Integration failed for observation point (-54939.9, 0) , source panel center at: (-55082.8, 0), panel_idx: 581, n_integrals: 100
Expansion center: (-54939.9, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.19973e-10 with tolerance: 1e-13
Integration failed for observation point (56632.4, 0) , source panel center at: (56489.4, 0), panel_idx: 58, n_integrals: 100
Expansion center: (56632.4, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.0596e-10 with tolerance: 1e-13
Integration failed for observation point (56388.2, 0) , source panel center at: (56245.3, 0), panel_idx: 59, n_integrals: 100
Expansion center: (56388.2, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.16624e-10 with tolerance: 1e-13
Integration failed for observation point (55655.8, 0) , source panel center at: (55512.9, 0), panel_idx: 62, n_integrals: 100
Expansion center: (55655.8, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.11747e-10 with tolerance: 1e-13
Integration failed for observation point (55411.7, 0) , source panel center at: (55268.7, 0), panel_idx: 63, n_integrals: 100
Expansion center: (55411.7, -0.0956594) with expansion radius: 0.0956594
The maximum estimated coefficient error: 1.12658e-10 with tolerance: 1e-13
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/tbent/Dropbox/active/eq/tectosaur2/tectosaur2/integrate.py:201: UserWarning: Some integrals failed to converge during adaptive integration. This an indication of a problem in either the integration or the problem formulation.
  warnings.warn(
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fault_slip_to_free_disp</span> <span class="o">=</span> <span class="n">fault_slip_to_free_disp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fault</span><span class="o">.</span><span class="n">n_pts</span><span class="p">))</span>
<span class="n">free_disp_to_free_disp</span> <span class="o">=</span> <span class="n">free_disp_to_free_disp</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">free</span><span class="o">.</span><span class="n">n_pts</span><span class="p">))</span>
<span class="n">free_disp_solve_mat</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">free_disp_to_free_disp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">free_disp_to_free_disp</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tectosaur2.elastic2d</span> <span class="kn">import</span> <span class="n">ElasticH</span>

<span class="p">(</span><span class="n">free_disp_to_fault_stress</span><span class="p">,</span> <span class="n">fault_slip_to_fault_stress</span><span class="p">),</span> <span class="n">report</span> <span class="o">=</span> <span class="n">integrate_term</span><span class="p">(</span>
    <span class="n">ElasticH</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">d_cutoff</span><span class="o">=</span><span class="mf">8.0</span><span class="p">),</span>
    <span class="c1"># elastic_h(nu),</span>
    <span class="n">fault</span><span class="o">.</span><span class="n">pts</span><span class="p">,</span>
    <span class="n">free</span><span class="p">,</span>
    <span class="n">fault</span><span class="p">,</span>
    <span class="n">tol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
    <span class="n">safety_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">singularities</span><span class="o">=</span><span class="n">singularities</span><span class="p">,</span>
    <span class="n">return_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fault_slip_to_fault_stress</span> <span class="o">*=</span> <span class="n">shear_modulus</span>
<span class="n">free_disp_to_fault_stress</span> <span class="o">*=</span> <span class="n">shear_modulus</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="o">-</span><span class="n">fault_slip_to_fault_stress</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fault</span><span class="o">.</span><span class="n">n_pts</span><span class="p">))</span>
<span class="n">B</span> <span class="o">=</span> <span class="o">-</span><span class="n">free_disp_to_fault_stress</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">free</span><span class="o">.</span><span class="n">n_pts</span><span class="p">))</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">fault_slip_to_free_disp</span>
<span class="n">Dinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">free_disp_solve_mat</span><span class="p">)</span>
<span class="n">total_fault_slip_to_fault_stress</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">B</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Dinv</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="n">nx</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">normals</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">ny</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">normals</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">normal_mult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">nx</span><span class="p">,</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span> <span class="o">*</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">]]),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">total_fault_slip_to_fault_traction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
    <span class="n">total_fault_slip_to_fault_stress</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">fault</span><span class="o">.</span><span class="n">n_pts</span><span class="p">,</span> <span class="mi">2</span><span class="p">))[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="o">*</span> <span class="n">normal_mult</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fault</span><span class="o">.</span><span class="n">n_pts</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="rate-and-state-friction">
<h2><span class="section-number">8.2. </span>Rate and state friction<a class="headerlink" href="#rate-and-state-friction" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">siay</span> <span class="o">=</span> <span class="mi">31556952</span>  <span class="c1"># seconds in a year</span>
<span class="n">density</span> <span class="o">=</span> <span class="mi">2670</span>  <span class="c1"># rock density (kg/m^3)</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">shear_modulus</span> <span class="o">/</span> <span class="n">density</span><span class="p">)</span>  <span class="c1"># Shear wave speed (m/s)</span>
<span class="n">Vp</span> <span class="o">=</span> <span class="mf">1e-9</span>  <span class="c1"># Rate of plate motion</span>
<span class="n">sigma_n0</span> <span class="o">=</span> <span class="mf">50e6</span>  <span class="c1"># Normal stress (Pa)</span>

<span class="c1"># parameters describing &quot;a&quot;, the coefficient of the direct velocity strengthening effect</span>
<span class="n">a0</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">amax</span> <span class="o">=</span> <span class="mf">0.025</span>
<span class="n">H</span> <span class="o">=</span> <span class="mi">15000</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">fx</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">fy</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">fy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">fd</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">H</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="o">-</span><span class="p">(</span><span class="n">H</span> <span class="o">+</span> <span class="n">h</span><span class="p">),</span> <span class="n">a0</span> <span class="o">+</span> <span class="p">(</span><span class="n">amax</span> <span class="o">-</span> <span class="n">a0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">fd</span> <span class="o">+</span> <span class="n">H</span><span class="p">)</span> <span class="o">/</span> <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">amax</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">mp</span> <span class="o">=</span> <span class="n">MaterialProps</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span> <span class="n">Dc</span><span class="o">=</span><span class="mf">0.008</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">V0</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">shear_modulus</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cs</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">fd</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mp</span><span class="o">.</span><span class="n">b</span><span class="p">),</span> <span class="n">fd</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mesh_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">fd</span><span class="p">)))</span>
<span class="n">Lb</span> <span class="o">=</span> <span class="n">shear_modulus</span> <span class="o">*</span> <span class="n">mp</span><span class="o">.</span><span class="n">Dc</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma_n0</span> <span class="o">*</span> <span class="n">mp</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
<span class="n">hstar</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">shear_modulus</span> <span class="o">*</span> <span class="n">mp</span><span class="o">.</span><span class="n">Dc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma_n0</span> <span class="o">*</span> <span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">b</span> <span class="o">-</span> <span class="n">mp</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
<span class="n">mesh_L</span><span class="p">,</span> <span class="n">Lb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">hstar</span><span class="p">[</span><span class="n">hstar</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="quasidynamic-earthquake-cycle-derivatives">
<h2><span class="section-number">8.3. </span>Quasidynamic earthquake cycle derivatives<a class="headerlink" href="#quasidynamic-earthquake-cycle-derivatives" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">fsolve</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="n">init_state_scalar</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="k">lambda</span> <span class="n">S</span><span class="p">:</span> <span class="n">aging_law</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">Vp</span><span class="p">,</span> <span class="n">S</span><span class="p">),</span> <span class="mf">0.7</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mp_amax</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
<span class="n">mp_amax</span><span class="o">.</span><span class="n">a</span><span class="o">=</span><span class="n">amax</span>
<span class="n">tau_amax</span> <span class="o">=</span> <span class="o">-</span><span class="n">qd_equation</span><span class="p">(</span><span class="n">mp_amax</span><span class="p">,</span> <span class="n">sigma_n0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Vp</span><span class="p">,</span> <span class="n">init_state_scalar</span><span class="p">)</span>
<span class="n">init_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">mp</span><span class="o">.</span><span class="n">V0</span><span class="o">/</span><span class="n">Vp</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">((</span><span class="n">tau_amax</span> <span class="o">-</span> <span class="n">mp</span><span class="o">.</span><span class="n">eta</span><span class="o">*</span><span class="n">Vp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="n">sigma_n0</span><span class="p">)))</span> <span class="o">*</span> <span class="n">mp</span><span class="o">.</span><span class="n">a</span>

<span class="n">init_tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fault</span><span class="o">.</span><span class="n">n_pts</span><span class="p">,</span> <span class="n">tau_amax</span><span class="p">)</span>
<span class="n">init_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fault</span><span class="o">.</span><span class="n">n_pts</span><span class="p">,</span> <span class="n">sigma_n0</span><span class="p">)</span>
<span class="n">init_slip_deficit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fault</span><span class="o">.</span><span class="n">n_pts</span><span class="p">)</span>
<span class="n">init_conditions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">init_slip_deficit</span><span class="p">,</span> <span class="n">init_state</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SystemState</span><span class="p">:</span>

    <span class="n">V_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fault</span><span class="o">.</span><span class="n">n_pts</span><span class="p">,</span> <span class="n">Vp</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Separate the slip_deficit and state sub components of the</span>
        <span class="c1"># time integration state.</span>
        <span class="n">slip_deficit</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span> <span class="n">init_slip_deficit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">init_slip_deficit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:]</span>

        <span class="c1"># If the state values are bad, then the adaptive integrator probably</span>
        <span class="c1"># took a bad step.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">state</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">state</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bad state&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># The big three lines solving for quasistatic shear stress, slip rate</span>
        <span class="c1"># and state evolution</span>
        <span class="n">sd_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">slip_deficit</span> <span class="o">*</span> <span class="o">-</span><span class="n">ny</span><span class="p">,</span> <span class="n">slip_deficit</span> <span class="o">*</span> <span class="n">nx</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">traction</span> <span class="o">=</span> <span class="n">total_fault_slip_to_fault_traction</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sd_vector</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">delta_sigma_qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">traction</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">delta_tau_qs</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">traction</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="o">-</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tau_qs</span> <span class="o">=</span> <span class="n">init_tau</span> <span class="o">+</span> <span class="n">delta_tau_qs</span>
        <span class="n">sigma_qs</span> <span class="o">=</span> <span class="n">init_sigma</span> <span class="o">+</span> <span class="n">delta_sigma_qs</span>

        <span class="n">V</span> <span class="o">=</span> <span class="n">solve_friction</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">sigma_qs</span><span class="p">,</span> <span class="n">tau_qs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_old</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">V</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;convergence failed&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">V</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;infinite V&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">dstatedt</span> <span class="o">=</span> <span class="n">aging_law</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_old</span> <span class="o">=</span> <span class="n">V</span>

        <span class="n">slip_deficit_rate</span> <span class="o">=</span> <span class="n">Vp</span> <span class="o">-</span> <span class="n">V</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">slip_deficit</span><span class="p">,</span>
            <span class="n">state</span><span class="p">,</span>
            <span class="n">delta_sigma_qs</span><span class="p">,</span>
            <span class="n">sigma_qs</span><span class="p">,</span>
            <span class="n">delta_tau_qs</span><span class="p">,</span>
            <span class="n">tau_qs</span><span class="p">,</span>
            <span class="n">V</span><span class="p">,</span>
            <span class="n">slip_deficit_rate</span><span class="p">,</span>
            <span class="n">dstatedt</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_system_state</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">SS</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is just a helper function that creates some rough plots of the</span>
<span class="sd">    current state to help with debugging&quot;&quot;&quot;</span>
    <span class="p">(</span>
        <span class="n">slip_deficit</span><span class="p">,</span>
        <span class="n">state</span><span class="p">,</span>
        <span class="n">delta_sigma_qs</span><span class="p">,</span>
        <span class="n">sigma_qs</span><span class="p">,</span>
        <span class="n">delta_tau_qs</span><span class="p">,</span>
        <span class="n">tau_qs</span><span class="p">,</span>
        <span class="n">V</span><span class="p">,</span>
        <span class="n">slip_deficit_rate</span><span class="p">,</span>
        <span class="n">dstatedt</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">SS</span>

    <span class="n">slip</span> <span class="o">=</span> <span class="n">Vp</span> <span class="o">*</span> <span class="n">t</span> <span class="o">-</span> <span class="n">slip_deficit</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">fault</span><span class="o">.</span><span class="n">pts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t=</span><span class="si">{</span><span class="n">t</span><span class="o">/</span><span class="n">siay</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;slip&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">slip</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;slip deficit&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">slip_deficit</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="c1"># plt.subplot(3, 3, 2)</span>
    <span class="c1"># plt.title(&quot;slip deficit rate&quot;)</span>
    <span class="c1"># plt.plot(fd, slip_deficit_rate)</span>
    <span class="c1"># plt.xlim(xlim)</span>

    <span class="c1"># plt.subplot(3, 3, 2)</span>
    <span class="c1"># plt.title(&quot;strength&quot;)</span>
    <span class="c1"># plt.plot(fd, tau_qs/sigma_qs)</span>
    <span class="c1"># plt.xlim(xlim)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># plt.title(&quot;log V&quot;)</span>
    <span class="c1"># plt.plot(fd, np.log10(V))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\sigma_</span><span class="si">{qs}</span><span class="s2">$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">sigma_qs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\tau_</span><span class="si">{qs}</span><span class="s2">$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">tau_qs</span><span class="p">,</span> <span class="s1">&#39;k-o&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta\sigma_</span><span class="si">{qs}</span><span class="s2">$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">delta_sigma_qs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">fd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta\tau_</span><span class="si">{qs}</span><span class="s2">$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">delta_tau_qs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">fd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;dstatedt&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">dstatedt</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calc_derivatives</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This helper function calculates the system state and then extracts the</span>
<span class="sd">    relevant derivatives that the integrator needs. It also intentionally</span>
<span class="sd">    returns infinite derivatives when the `y` vector provided by the integrator</span>
<span class="sd">    is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">state_vecs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">calc</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">state_vecs</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">derivatives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">state_vecs</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">state_vecs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">derivatives</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="integrating-through-time">
<h2><span class="section-number">8.4. </span>Integrating through time<a class="headerlink" href="#integrating-through-time" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">RK23</span><span class="p">,</span> <span class="n">RK45</span>

<span class="c1"># We use a 5th order adaptive Runge Kutta method and pass the derivative function to it</span>
<span class="c1"># the relative tolerance will be 1e-11 to make sure that even</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">SystemState</span><span class="p">()</span>
<span class="n">derivs</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">calc_derivatives</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">integrator</span> <span class="o">=</span> <span class="n">RK45</span>
<span class="n">atol</span> <span class="o">=</span> <span class="n">Vp</span> <span class="o">*</span> <span class="mf">1e-6</span>
<span class="n">rtol</span> <span class="o">=</span> <span class="mf">1e-11</span>
<span class="n">rk</span> <span class="o">=</span> <span class="n">integrator</span><span class="p">(</span><span class="n">derivs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">init_conditions</span><span class="p">,</span> <span class="mf">1e50</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">)</span>

<span class="c1"># Set the initial time step to one day.</span>
<span class="n">rk</span><span class="o">.</span><span class="n">h_abs</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span>

<span class="c1"># Integrate for 1000 years.</span>
<span class="n">max_T</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">siay</span>

<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">50000</span>
<span class="n">t_history</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">y_history</span> <span class="o">=</span> <span class="p">[</span><span class="n">init_conditions</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
    <span class="c1"># Take a time step and store the result</span>
    <span class="k">if</span> <span class="n">rk</span><span class="o">.</span><span class="n">step</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;TIME STEPPING FAILED&quot;</span><span class="p">)</span>
    <span class="n">t_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rk</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    <span class="n">y_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rk</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="c1"># Print the time every 5000 steps</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;step=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, time=</span><span class="si">{</span><span class="n">rk</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">siay</span><span class="si">}</span><span class="s2"> yrs, step=</span><span class="si">{</span><span class="p">(</span><span class="n">rk</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_history</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">siay</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># if i % 500 == 0:</span>
    <span class="c1">#     print(f&quot;step={i}, time={rk.t / siay} yrs, step={(rk.t - t_history[-2]) / siay}&quot;)</span>
    <span class="c1">#     plot_system_state(rk.t, state.calc(rk.t, rk.y))#, xlim=[-21000, -14000])</span>

    <span class="k">if</span> <span class="n">rk</span><span class="o">.</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">max_T</span><span class="p">:</span>
        <span class="k">break</span>

<span class="n">y_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_history</span><span class="p">)</span>
<span class="n">t_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_history</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plotting-the-results">
<h2><span class="section-number">8.5. </span>Plotting the results<a class="headerlink" href="#plotting-the-results" title="Permalink to this headline">¶</a></h2>
<p>Now that we’ve solved for 1000 years of fault slip evolution, let’s plot some of the results. I’ll start with a super simple plot of the maximum log slip rate over time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">derivs_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">y_history</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t_history</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">max_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">derivs_history</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_history</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">siay</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">max_vel</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$t ~~ \mathrm{(yrs)}$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1">(V)$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>And next, we’ll make the classic plot showing the spatial distribution of slip over time:</p>
<ul class="simple">
<li><p>the blue lines show interseismic slip evolution and are plotted every fifteen years</p></li>
<li><p>the red lines show evolution during rupture every three seconds.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">last_plt_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
<span class="n">last_plt_slip</span> <span class="o">=</span> <span class="n">init_slip_deficit</span>
<span class="n">event_times</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_history</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">slip_deficit</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span> <span class="n">init_slip_deficit</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">should_plot</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Plot a red line every three second if the slip rate is over 0.1 mm/s.</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">max_vel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.0001</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">-</span> <span class="n">last_plt_t</span> <span class="o">&gt;</span> <span class="mi">3</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_times</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">-</span> <span class="n">event_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">siay</span><span class="p">:</span>
            <span class="n">event_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">should_plot</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>

    <span class="c1"># Plot a blue line every fifteen years during the interseismic period</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">-</span> <span class="n">last_plt_t</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">siay</span><span class="p">:</span>
        <span class="n">should_plot</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>

    <span class="k">if</span> <span class="n">should_plot</span><span class="p">:</span>
        <span class="c1"># Convert from slip deficit to slip:</span>
        <span class="n">slip</span> <span class="o">=</span> <span class="o">-</span><span class="n">slip_deficit</span> <span class="o">+</span> <span class="n">Vp</span> <span class="o">*</span> <span class="n">t</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">slip</span><span class="p">,</span> <span class="n">fd</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">color</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">last_plt_t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">last_plt_slip</span> <span class="o">=</span> <span class="n">slip</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">last_plt_slip</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\textrm{z (km)}$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\textrm{slip (m)}$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;halfspace.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>And a plot of recurrence interval:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Recurrence interval&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">event_times</span><span class="p">)</span> <span class="o">/</span> <span class="n">siay</span><span class="p">,</span> <span class="s2">&quot;k-*&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Event number&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Time between events (yr)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="comparison-against-scec-seas-results">
<h2><span class="section-number">8.6. </span>Comparison against SCEC SEAS results<a class="headerlink" href="#comparison-against-scec-seas-results" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ozawa_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;ozawa7500.txt&quot;</span><span class="p">)</span>
<span class="n">ozawa_slip_rate</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">ozawa_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">ozawa_stress</span> <span class="o">=</span> <span class="n">ozawa_data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t_start_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">max_vel</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">)</span>
<span class="n">t_end_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">max_vel</span><span class="p">[</span><span class="n">t_start_idx</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">)</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="n">t_end_idx</span> <span class="o">-</span> <span class="n">t_start_idx</span>
<span class="n">t_chunk</span> <span class="o">=</span> <span class="n">t_history</span><span class="p">[</span><span class="n">t_start_idx</span> <span class="p">:</span> <span class="n">t_end_idx</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shear_chunk</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">slip_rate_chunk</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
    <span class="n">system_state</span> <span class="o">=</span> <span class="n">SystemState</span><span class="p">()</span><span class="o">.</span><span class="n">calc</span><span class="p">(</span><span class="n">t_history</span><span class="p">[</span><span class="n">t_start_idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="n">y_history</span><span class="p">[</span><span class="n">t_start_idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span>
    <span class="n">slip_deficit</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">delta_sigma_qs</span><span class="p">,</span> <span class="n">sigma_qs</span><span class="p">,</span> <span class="n">delta_tau_qs</span><span class="p">,</span> <span class="n">tau_qs</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">slip_deficit_rate</span><span class="p">,</span> <span class="n">dstatedt</span> <span class="o">=</span> <span class="n">system_state</span>
    <span class="n">shear_chunk</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tau_qs</span> <span class="o">-</span> <span class="n">mp</span><span class="o">.</span><span class="n">eta</span> <span class="o">*</span> <span class="n">V</span><span class="p">))</span>
    <span class="n">slip_rate_chunk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">shear_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shear_chunk</span><span class="p">)</span>
<span class="n">slip_rate_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slip_rate_chunk</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fault_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">((</span><span class="o">-</span><span class="mi">7450</span> <span class="o">&gt;</span> <span class="n">fd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">7550</span><span class="p">))</span>
<span class="n">VAvg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">slip_rate_chunk</span><span class="p">[:,</span> <span class="n">fault_idx</span><span class="p">:(</span><span class="n">fault_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">SAvg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shear_chunk</span><span class="p">[:,</span> <span class="n">fault_idx</span><span class="p">:(</span><span class="n">fault_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fault_idx</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t_align</span> <span class="o">=</span> <span class="n">t_chunk</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">VAvg</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">)]</span>
<span class="n">ozawa_t_align</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ozawa_slip_rate</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">)</span>

<span class="k">for</span> <span class="n">lims</span> <span class="ow">in</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">)]:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_chunk</span> <span class="o">-</span> <span class="n">t_align</span><span class="p">,</span> <span class="n">SAvg</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="s2">&quot;k-o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;here&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">ozawa_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ozawa_data</span><span class="p">[</span><span class="n">ozawa_t_align</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">ozawa_stress</span><span class="p">,</span>
        <span class="s2">&quot;b-*&quot;</span><span class="p">,</span>
        <span class="n">markersize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ozawa&#39;</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Shear Stress (MPa)&quot;</span><span class="p">)</span>
    <span class="c1"># plt.show()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_chunk</span> <span class="o">-</span> <span class="n">t_align</span><span class="p">,</span> <span class="n">VAvg</span><span class="p">,</span> <span class="s2">&quot;k-o&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;here&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">ozawa_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ozawa_data</span><span class="p">[</span><span class="n">ozawa_t_align</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="n">ozawa_slip_rate</span><span class="p">[:],</span>
        <span class="s2">&quot;b-*&quot;</span><span class="p">,</span>
        <span class="n">markersize</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ozawa&#39;</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Slip rate (m/s)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./c1qbx"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="part7_qd_two_faults.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">7. </span>Quasidynamic earthquake cycles on two faults</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../volumetric/part1_solve_circle.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">1. </span>[DRAFT] Solving a Dirichlet problem on a circle.</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By T. Ben Thompson<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>